



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="A tutorial covering practical elements of metagenomic analysis">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.3">
    
    
      
        <title>Quality Control - Metagenomics Tutorial</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.30686662.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#3f51b5">
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#sequencing-run-qc" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href=".." title="Metagenomics Tutorial" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Metagenomics Tutorial
            </span>
            <span class="md-header-nav__topic">
              
                Quality Control
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/thegeneschool/metagenomics/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    thegeneschool/metagenomics
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

<nav class="md-tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href=".." title="Metagenomics Tutorial" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Metagenomics Tutorial
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/thegeneschool/metagenomics/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    thegeneschool/metagenomics
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../startup/" title="Jupyter Setup" class="md-nav__link">
      Jupyter Setup
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Quality Control
      </label>
    
    <a href="./" title="Quality Control" class="md-nav__link md-nav__link--active">
      Quality Control
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#get-some-sequence-data" class="md-nav__link">
    Get some sequence data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#evaluating-sequence-quality-with-fastqc-and-multiqc" class="md-nav__link">
    Evaluating sequence quality with FastQC and MultiQC
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cleaning-up-reads-with-fastp" class="md-nav__link">
    Cleaning up reads with fastp
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#taxonomic-analysis" class="md-nav__link">
    Taxonomic analysis
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#taxonomic-analysis-with-metaphlan2" class="md-nav__link">
    Taxonomic analysis with Metaphlan2
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#taxonomic-analysis-with-other-tools" class="md-nav__link">
    Taxonomic analysis with other tools
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#evaluating-the-host-genomic-content" class="md-nav__link">
    Evaluating the host genomic content
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-do-you-see" class="md-nav__link">
    What do you see?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#some-challenge-questions" class="md-nav__link">
    Some challenge questions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-note-on-negative-controls" class="md-nav__link">
    A note on negative controls
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../assembly/" title="Assembly" class="md-nav__link">
      Assembly
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../binning/" title="Binning" class="md-nav__link">
      Binning
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../hic/" title="Hi-C" class="md-nav__link">
      Hi-C
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../anvio/" title="Visualization" class="md-nav__link">
      Visualization
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../everythingelse/" title="Everything Else" class="md-nav__link">
      Everything Else
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#get-some-sequence-data" class="md-nav__link">
    Get some sequence data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#evaluating-sequence-quality-with-fastqc-and-multiqc" class="md-nav__link">
    Evaluating sequence quality with FastQC and MultiQC
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cleaning-up-reads-with-fastp" class="md-nav__link">
    Cleaning up reads with fastp
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#taxonomic-analysis" class="md-nav__link">
    Taxonomic analysis
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#taxonomic-analysis-with-metaphlan2" class="md-nav__link">
    Taxonomic analysis with Metaphlan2
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#taxonomic-analysis-with-other-tools" class="md-nav__link">
    Taxonomic analysis with other tools
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#evaluating-the-host-genomic-content" class="md-nav__link">
    Evaluating the host genomic content
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-do-you-see" class="md-nav__link">
    What do you see?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#some-challenge-questions" class="md-nav__link">
    Some challenge questions
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-note-on-negative-controls" class="md-nav__link">
    A note on negative controls
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/thegeneschool/metagenomics/edit/master/docs/qc.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="sequencing-run-qc">Sequencing run QC<a class="headerlink" href="#sequencing-run-qc" title="Permanent link">&para;</a></h1>
<h2 id="get-some-sequence-data">Get some sequence data<a class="headerlink" href="#get-some-sequence-data" title="Permanent link">&para;</a></h2>
<p>The first thing we'll do is to get some sequence data to work with. If you are working on a new sequencing project the data might instead come directly from a sequencing facility. For this tutorial we'll work with data that is available in public databases.</p>
<p>Published sequence data is usually archived in the NCBI SRA, the ENA, and the DDBJ.
Each of these databases provide <a href="https://www.ncbi.nlm.nih.gov/">convenient search interfaces</a>, which can be used to find samples by keyword and sample type (e.g. shotgun metagenome).
The data-sets we'll use in the following exercises (SRA accessions SRR9323808, SRR9323810, SRR9323811, SRR9323809) are small in size and therefore quick to process.</p>
<p>With an accession number in hand, the easiest way to obtain the related sequencing data from the databases is via the <code>fastq-dump</code> software.</p>
<p>First, let's create a new conda environment, install Python along with the SRA Toolkit and the activate it.
To do this, start a terminal session in your Jupyter server (click the Terminal icon) and run the following command (its ok to copy and paste):</p>
<div class="admonition example">
<p class="admonition-title">Setup an initial set of tools</p>
<div class="codehilite"><pre><span></span><span class="c1"># fast download from github</span>
git clone https://github.com/rvalieris/parallel-fastq-dump.git
<span class="c1"># create a new conda environment and activate it</span>
conda create -y -n workshop <span class="s2">&quot;python&lt;3&quot;</span> sra-tools
conda activate workshop
</pre></div>

</div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>We've just created a new conda environment and activated it. You will see your prompt now tells you this fact with <code>(workshop)</code>.    </p>
</div>
<p>Now that you've installed fastq-dump we can use it to download data by accession number. Copy and paste the following to your terminal:</p>
<div class="admonition example">
<p class="admonition-title">Download the sequencing data for our data-sets</p>
<div class="codehilite"><pre><span></span>parallel-fastq-dump/parallel-fastq-dump -s SRR9323808 -s SRR9323810 -s SRR9323811 -s SRR9323809 <span class="se">\</span>
    --threads <span class="m">4</span> --split-files --gzip --outdir qc_data/
</pre></div>

</div>
<p>If the download was successful, a new subfolder <code>qc_data</code> should exist and within that you should find the fastq files. Using your terminal session, try listing the contents of the subfolder (<code>ls qc_data</code>). You should see something like the following:</p>
<div class="admonition info">
<p class="admonition-title">You can check that the fastq files exist</p>
<p><img alt="Screenshot of parallel-fastq-dump" src="../img/screenshot_fastq_dump.png" style="margin-left: 5%; width:90%" /></p>
</div>
<h2 id="evaluating-sequence-quality-with-fastqc-and-multiqc">Evaluating sequence quality with FastQC and MultiQC<a class="headerlink" href="#evaluating-sequence-quality-with-fastqc-and-multiqc" title="Permanent link">&para;</a></h2>
<p>The very first thing one would normally do when working with a new dataset is to look at some basic quality statistics on the data.
There are many, many tools available to compute quality metrics. For our current data we will use the FastQC software, applied to each sample, and then combine the results using MultiQC to a single report. First step is to install <code>fastqc</code> and <code>multiqc</code>.</p>
<div class="admonition example">
<p class="admonition-title">Install <code>fastqc</code> and <code>multiqc</code> for QC analysis</p>
<div class="codehilite"><pre><span></span>conda install -y -n workshop fastqc multiqc
</pre></div>

</div>
<p>In the above we've used conda to install fastqc, but we've used another way to install multiqc -- something called <code>pip</code>. pip is an installer for python programs, and like conda it will download and install the software along with any dependencies. The reason we use pip in this case is because conda can be very, very slow to install some programs and in this case pip is much faster.</p>
<div class="admonition example">
<p class="admonition-title">Use fastqc to analyse the datasets</p>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> qc_data
ls *.fastq.gz <span class="p">|</span> xargs fastqc
</pre></div>

</div>
<div class="admonition info">
<p class="admonition-title">Unpacking the commands</p>
<ol>
<li>First we change the current directory (<code>cd qc_data</code>).<ul>
<li>any subsequent command will, by default, now run in qc_data.</li>
</ul>
</li>
<li>Next we get the list of fastq files (<code>ls *.fastq.gz</code>) and pass that to <code>xargs</code>. <ul>
<li>the wildcard expression (<code>*.fastq.gz</code>) matches all of the sequencing data files.</li>
<li>this list of files is then piped (<code>|</code>) to the next command <code>xargs</code>.</li>
<li>the <code>xargs</code> command allows you to build and execute command lines. In this simplest form, <code>xargs</code> merely takes the list of files it receives and makes them arguments to <code>fastqc</code>.</li>
<li><code>fastqc</code> is then run, where each of the fastq files will included as an argument. </li>
</ul>
</li>
</ol>
</div>
<p>If this step has worked, then you should have several new <code>.zip</code> files containing the QC data in that directory, along with some html files. When we have a lot of samples it is too tedious to look at all the QC reports individually for each sample, so we can summarize them using multiqc.</p>
<div class="admonition example">
<p class="admonition-title">Create a summary report</p>
<div class="codehilite"><pre><span></span>multiqc --title <span class="s2">&quot;Raw Reads&quot;</span> .
</pre></div>

</div>
<p>At this point a multiqc report file will appear inside the QC directory. First double click to open the QC folder.</p>
<div class="admonition info">
<p class="admonition-title">Opening our working directory in Jupyter</p>
<p><img alt="Screenshot of QC folder" src="../img/qc_folder.png" style="margin-left: 25%; width:50%" /></p>
</div>
<p>Once we've navigated to the QC directory, a file called <code>Raw-Reads_multiqc_report.html</code> will appear in the listing. To open this report, simply double-click on the file name and a new tab will appear in Jupyter. </p>
<div class="admonition info">
<p class="admonition-title">Opening the HTML report in Jupyter</p>
<p><img alt="Opening MultiQC context menu" src="../img/qc_open_in_browser_tab.png" style="margin-left: 25%; width:50%" /></p>
</div>
<p>Switching to the report tab, first click "Trust HTML" button in the top left-hand corner. Doing this will permit JavaScript to execute within the page, which is used for drawing the figures.</p>
<div class="admonition info">
<p class="admonition-title">Opening the HTML report in Jupyter</p>
<p><img alt="Opening MultiQC context menu" src="../img/trust_html.png" style="margin-left: 25%; width:50%" /></p>
</div>
<p>From here we can evaluate the quality of the libraries.</p>
<h2 id="cleaning-up-reads-with-fastp">Cleaning up reads with fastp<a class="headerlink" href="#cleaning-up-reads-with-fastp" title="Permanent link">&para;</a></h2>
<p>Now that we have evaluated the condition of our raw data-sets, we are in a better position to judge whether everything looks ok. Though we may feel that our data is in an acceptable state for further analysis, sometimes smaller details can escape us. Therefore, subjecting data-sets to a experimentally suitable clean-up procedure is good practice. What is suitable for a given experiment depends on what will ultimately be inferred. In the case of assembly, contaminating sequence or an abundance of low-quality base-calls will likely lead to worse results. Therefore, identifying and removing this type of error will be advantageous. In constrast, clean-up procedures the attempt to correct base-calling errors can be inappropriate when a sample is not clonal (ie. metagenomics). Here, the assumption that SNV are errors, leads to software removing the micro-diversity within the sample.</p>
<p>While sequencing technology continues to evolve and refine, data-sets generated from even the latest NGS platforms will not be error-free. There exist both random and systematic sources of error in sequencing data and a wide assortment of tools are available to identify and eliminate them. It is important to note that not every clean-up procedure is appropriate for all types of experiment and care should be taken not to falsely remove true observations from your data.</p>
<p>For our shotgun sequencing data, we will use <code>fastp</code>, which runs quickly and is easy to use.</p>
<div class="admonition example">
<p class="admonition-title">Install fastp for cleaning up reads</p>
<div class="codehilite"><pre><span></span>conda install -y -n workshop fastp
</pre></div>

</div>
<p>By default, <code>fastp</code> will apply the following clean-ups:</p>
<ol>
<li>automatically identify and remove lingering adapter sequence.</li>
<li>trim off low quality bases on the tail-end.</li>
<li>filter out very short reads and reads with too many Ns.</li>
</ol>
<p>Lingering adapter sequence can be thought of an experimental contamination and represents a misleading source of systematic error, while low quality base calls are more-so a source of random error.</p>
<div class="admonition example">
<p class="admonition-title">Run <code>fastp</code> on our data-sets</p>
<div class="codehilite"><pre><span></span>mkdir cleaned
<span class="k">for</span> r1 in <span class="k">$(</span>ls *_1.fastq.gz<span class="k">)</span>
<span class="k">do</span>
    <span class="c1"># extract the SRR from the filename</span>
    <span class="nv">srr</span><span class="o">=</span><span class="k">$(</span>basename <span class="nv">$r1</span> _1.fastq.gz<span class="k">)</span>
    <span class="c1"># run fastp on paired reads</span>
    fastp --in1 <span class="si">${</span><span class="nv">srr</span><span class="si">}</span>_1.fastq.gz --in2 <span class="si">${</span><span class="nv">srr</span><span class="si">}</span>_2.fastq.gz <span class="se">\</span>
          --out1 cleaned/<span class="si">${</span><span class="nv">srr</span><span class="si">}</span>_1.fastq.gz --out2 cleaned/<span class="si">${</span><span class="nv">srr</span><span class="si">}</span>_2.fastq.gz
<span class="k">done</span>
</pre></div>

</div>
<div class="admonition info">
<p class="admonition-title">Unpacking the commands</p>
<ol>
<li>create a new subfolder for holding the cleaned data-sets (<code>mkdir cleaned</code>)</li>
<li>using a for-loop in Bash, individually submit R1/R2 pairs to fastp<ul>
<li>the loop iterates over the list of just R1 files, obtained using the wildcard <code>*_1.fastq.gz</code></li>
<li>for each R1 file, extract the base SRR id (<code>srr=$(basename $r1 _1.fastq.gz)</code>)</li>
<li>call fastp for paired R1/R2 files, constructing from the srr:<ul>
<li>the input files (<code>${srr}_1.fastq.gz</code>, <code>${srr}_2.fastq.gz</code>)</li>
<li>the output files (<code>cleaned/${srr}_1.fastq.gz</code>, <code>cleaned/${srr}_2.fastq.gz</code>)</li>
</ul>
</li>
</ul>
</li>
</ol>
</div>
<p>Although <code>fastp</code> produces its own reports, we will again use <code>fastqc</code> and <code>multiqc</code> so that we can compare our cleaned and raw data-sets. </p>
<div class="admonition example">
<p class="admonition-title">Perform QC analysis on the cleaned data-sets</p>
<div class="codehilite"><pre><span></span>ls cleaned/*.fastq.gz <span class="p">|</span> xargs fastqc
multiqc --title <span class="s2">&quot;Cleaned Reads&quot;</span> cleaned
</pre></div>

</div>
<p>The resulting <code>multiqc</code> report will be entitled <code>Cleaned-Reads_multiqc_report.html</code>. Double click this file in Jupyter to open the tab and select "Trust HTML" to enable the JavaScript figures as described above for the raw data-sets.</p>
<p>As none of our data-sets suffers from serious problems, when we compare the Raw and Cleaned reports, there are not many obvious changes. One difference that is easily noticeable is found in the section "<em>Adapter Content</em>". Although only a small proportion of reads were affected by lingering adapter sequence in the raw data-sets, <code>fastp</code> has removed what remained. Without too much effort, we have eliminated a source of systematic error -- tools downstream will no longer be tasked with reconciling an artifact of data collection with real observations.</p>
<h2 id="taxonomic-analysis">Taxonomic analysis<a class="headerlink" href="#taxonomic-analysis" title="Permanent link">&para;</a></h2>
<p>Metagenome taxonomic analysis offers a means to estimate a microbial community profile from metagenomic sequence data.
It can give us a very high-level, rough idea of what kinds of microbes are present in a sample.
It can also give an idea of how complex/diverse the microbial community is -- whether there are many species or few.
It is useful as an initial quality check to ensure that the microbial community composition looks roughly as expected, and to confirm that nothing obvious went wrong during the sample collection and sequencing steps.</p>
<h3 id="taxonomic-analysis-with-metaphlan2">Taxonomic analysis with Metaphlan2<a class="headerlink" href="#taxonomic-analysis-with-metaphlan2" title="Permanent link">&para;</a></h3>
<p>While it may be possible to install metaphlan2 via conda, at least in my experience, conda struggles with "solving the environment".
Therefore it's suggested to install it via the simple download method described on the <a href="https://bitbucket.org/nsegata/metaphlan/wiki/MetaPhlAn_Pipelines_Tutorial">metaphlan tutorial page</a>:</p>
<div class="admonition warning">
<p class="admonition-title">Skip downloading metaphlan2</p>
<p>The &gt;500MB Metaphlan2 package has already been downloaded and we'll just be extracting it.</p>
</div>
<div class="admonition example">
<p class="admonition-title">Obtaining <code>metaphlan</code></p>
<div class="codehilite"><pre><span></span><span class="c1"># this would be how you could download the package yourself</span>
<span class="c1"># wget -c -O metaphlan.tar.bz2 https://bitbucket.org/nsegata/metaphlan/get/default.tar.bz2</span>

<span class="c1"># extract the archive</span>
<span class="nb">cd</span> <span class="p">;</span> tar xvjf /data/metaphlan.tar.bz2
<span class="c1"># rename the folder to something simple</span>
mv nsegata-metaphlan* metaphlan
<span class="c1"># apply a technical fix for metaphlan plotting</span>
sed -i <span class="s1">&#39;s/axisbg/facecolor/&#39;</span> metaphlan/plotting_scripts/metaphlan_hclust_heatmap.py
<span class="c1"># install dependencies</span>
conda install -y -n workshop bowtie2 numpy scipy matplotlib
</pre></div>

</div>
<p>Once <code>metaphlan</code> has been prepared we can run it on our QC samples:</p>
<div class="admonition example">
<p class="admonition-title">Running <code>metaphlan</code> on our data</p>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> ~/qc_data
<span class="k">for</span> pig in SRR9323808 SRR9323810 SRR9323811 SRR9323809
<span class="k">do</span>
     zcat <span class="si">${</span><span class="nv">pig</span><span class="si">}</span>*.fastq.gz <span class="p">|</span> ~/metaphlan/metaphlan.py --input_type multifastq --bt2_ps very-sensitive <span class="se">\</span>
            --bowtie2db ~/metaphlan/bowtie2db/mpa --bowtie2out <span class="si">${</span><span class="nv">pig</span><span class="si">}</span>.bt2out -o <span class="si">${</span><span class="nv">pig</span><span class="si">}</span>.mph2
<span class="k">done</span>
</pre></div>

</div>
<div class="admonition info">
<p class="admonition-title">Unpacking the commands</p>
<p>The above series of commands is another exampe of a Bash "for loop", where each iteration processes one of our metagenome samples. As before, this is a convenient and less error-prone way to process many samples by avoiding the need to type out the commands for each sample. At each loop iteration, one of the sample names is placed into the loop variable <code>${pig}</code>, where it can get used in the command inside the loop.</p>
<p>Secondly, we decompress (<code>zcat</code>) and then feed each pig's sequencing data to <code>metaphlan</code> through a pipe (<code>|</code>)</p>
</div>
<p>Finally we can plot the taxonomic profile of the samples:</p>
<div class="admonition example">
<p class="admonition-title">Plot the taxonomic profile of each sample</p>
<div class="codehilite"><pre><span></span>~/metaphlan/utils/merge_metaphlan_tables.py *.mph2 &gt; pig_mph2.merged
~/metaphlan/plotting_scripts/metaphlan_hclust_heatmap.py -c bbcry --top 25 --minv 0.1 -s log --in pig_mph2.merged --out mph2_heatmap.png
</pre></div>

</div>
<p>Once that has completed successfully, a new file called <code>mph2_heatmap.png</code> will appear in the qc_data folder of our Jupyter file browser. We can double click it to view.</p>
<p>There are other ways to visualize the data, and they are described in the graphlan section of the <a href="https://bitbucket.org/nsegata/metaphlan/wiki/MetaPhlAn_Pipelines_Tutorial">metaphlan tutorial</a> page.</p>
<h3 id="taxonomic-analysis-with-other-tools">Taxonomic analysis with other tools<a class="headerlink" href="#taxonomic-analysis-with-other-tools" title="Permanent link">&para;</a></h3>
<p>There are a whole range of other software tools available for metagenome taxonomic analysis. 
They all have strengths and weaknesses.</p>
<p>A few other commonly used tools are listed here:</p>
<ul>
<li><a href="https://ccb.jhu.edu/software/kraken2/index.shtml">kraken2</a></li>
<li><a href="http://ab.inf.uni-tuebingen.de/software/megan6/">MEGAN</a></li>
<li><a href="http://www.ccb.jhu.edu/software/centrifuge/manual.shtml">Centrifuge</a></li>
<li><a href="http://clark.cs.ucr.edu/">CLARK</a></li>
</ul>
<h2 id="evaluating-the-host-genomic-content">Evaluating the host genomic content<a class="headerlink" href="#evaluating-the-host-genomic-content" title="Permanent link">&para;</a></h2>
<p>In many applications of metagenomics we are working with host-associated samples. 
The samples might have come from an animal gut, mouth, or other surface.
Similarly for plants we might be working with leaf or root surfaces or rhizobia.
When such samples are collected the resulting DNA extracts can include a significant fraction of host material.
Let's have a look at what this looks like in data.
To do so, we'll download another set of pig gut samples: a set of samples that was taken using scrapings or swabs from different parts of the porcine digestive system, including the duodenum, jejunum, ileum, colon, and caecum.
Rather than using <code>metaphlan2</code> to profile these, we will use the <code>kraken2</code> classifier in conjunction with the bracken tool for estimating relative abundances.
We first need to install <code>kraken2</code> and <code>bracken</code>:</p>
<div class="admonition example">
<p class="admonition-title">Install <code>kraken2</code> and <code>braken</code></p>
<div class="codehilite"><pre><span></span>conda install -y -n workshop kraken2 bracken
</pre></div>

</div>
<p>Next, we need a <code>kraken2</code> database.</p>
<p>For this tutorial we will simply use a precomputed <code>kraken2</code> database, note however, the very important limitation that the only non-microbial genome it includes is the human genome.
If you would like to evaluate host genomic content on plants or other things, you should follow the instructions on the <code>kraken2</code> web site to build a complete database.</p>
<div class="admonition warning">
<p class="admonition-title">Skip downloading the database</p>
<p>The Kraken team maintain this and a number of other prepared databases which they make available for download. However, as a matter of courtesy, we will avoid repeatedly requesting the same data.</p>
</div>
<p>The archive has already been downloaded and we will just be extracting the contents as follows:</p>
<div class="admonition example">
<p class="admonition-title">Extract the precomputed <code>kraken2</code> reference database</p>
<div class="codehilite"><pre><span></span><span class="nb">cd</span> <span class="p">;</span> tar xvzf /data/minikraken2_v2_8GB_201904_UPDATE.tgz
</pre></div>

</div>
<p>Finally we are ready to profile our samples with <code>kraken2</code> and <code>bracken</code>.</p>
<p>We'll first download the sample set with <code>parallel-fastq-dump</code> and then run <code>kraken2</code> and <code>bracken</code>'s <code>est_abundance.py</code> script on each sample using a bash for loop.
The analysis can be run as follows:</p>
<div class="admonition example">
<p class="admonition-title">Download some new samples</p>
<div class="codehilite"><pre><span></span><span class="c1"># the list of samples</span>
<span class="nv">samples</span><span class="o">=</span><span class="s2">&quot;SRR9332442 SRR9332438 SRR9332439 SRR9332443 SRR9332440&quot;</span>
<span class="c1"># download the associated data</span>
parallel-fastq-dump/parallel-fastq-dump <span class="si">${</span><span class="nv">samples</span><span class="p">//SRR/-s SRR</span><span class="si">}</span> --threads <span class="m">4</span> --split-files <span class="se">\</span>
        --gzip --outdir host_qc/
<span class="c1"># switch to the data directory and analyse</span>
<span class="nb">cd</span> host_qc
<span class="k">for</span> s in <span class="nv">$samples</span>
<span class="k">do</span>
    <span class="c1"># run kraken2 analysis</span>
    kraken2 --paired <span class="si">${</span><span class="nv">s</span><span class="si">}</span>_1.fastq.gz <span class="si">${</span><span class="nv">s</span><span class="si">}</span>_2.fastq.gz --db ~/minikraken2_v2_8GB_201904_UPDATE/ <span class="se">\</span>
        --report <span class="si">${</span><span class="nv">s</span><span class="si">}</span>.kreport &gt; <span class="si">${</span><span class="nv">s</span><span class="si">}</span>.kraken
    <span class="c1"># estimate abundance with braken</span>
    est_abundance.py -i <span class="si">${</span><span class="nv">s</span><span class="si">}</span>.kreport -o <span class="si">${</span><span class="nv">s</span><span class="si">}</span>.bracken <span class="se">\</span>
        -k ~/minikraken2_v2_8GB_201904_UPDATE/database150mers.kmer_distrib
<span class="k">done</span>
</pre></div>

</div>
<p>Once the above has completed, navigate over to the <code>host_qc</code> folder in the Jupyter file browser and click on the <code>*.bracken</code> files to open them.</p>
<h4 id="what-do-you-see">What do you see?<a class="headerlink" href="#what-do-you-see" title="Permanent link">&para;</a></h4>
<p>In particular, why does sample SRR9332438 look so different to sample SRR9332440?</p>
<p>Keep in mind the isolation sources of the samples were as follows:</p>
<table>
<thead>
<tr>
<th>Sample</th>
<th>Source</th>
</tr>
</thead>
<tbody>
<tr>
<td>SRR9332442</td>
<td>Duodenum</td>
</tr>
<tr>
<td>SRR9332440</td>
<td>Caecum</td>
</tr>
<tr>
<td>SRR9332439</td>
<td>Ileum</td>
</tr>
<tr>
<td>SRR9332438</td>
<td>Jejunum</td>
</tr>
<tr>
<td>SRR9332443</td>
<td>Colon</td>
</tr>
</tbody>
</table>
<h4 id="some-challenge-questions">Some challenge questions<a class="headerlink" href="#some-challenge-questions" title="Permanent link">&para;</a></h4>
<ul>
<li>If we sequenced samples from pigs, why is human DNA being predicted in these samples?</li>
<li>If we were to design a large study around these samples which of them would be suitable for metagenomics, and why?</li>
<li>How much sequencing data would we need to generate from sample SRR9332440 to reconstruct the genome of the <em>Bifidobacterium</em> in that sample? What about the <em>E. coli</em>?</li>
<li>Are there really six species of <em>Lactobacillus</em> present in SRR9332440?</li>
<li>Go to the <a href="https://trace.ncbi.nlm.nih.gov/Traces/sra/sra.cgi?view=search_obj">NCBI SRA search tool</a> and find a metagenome of interest to you. Download the first 100000 reads from it (use the <code>--maxSpotId</code> parameter) and analyse it with kraken2. Is it what you expected? How does it compare to the others we've looked at?</li>
</ul>
<h2 id="a-note-on-negative-controls">A note on negative controls<a class="headerlink" href="#a-note-on-negative-controls" title="Permanent link">&para;</a></h2>
<p>Negative controls are a key element in any microbiome profiling or metagenome analysis work.
Every aspect of the sample collection and processing can be impacted by the presence of contaminating microbial DNA.
This is true even of 'sterile' material -- just because no viable cells exist in a sample collection swab, for example, does not mean there is no microbial DNA on that swab.
It is well known that molecular biology reagents frequently contain contaminating DNA.
Usually it is at low levels, but this is not always the case.</p>
<p>Therefore, the best practice is to collect multiple negative control samples that are taken all the way through sequencing.
These negative controls can then be used to correct for contamination artifacts in the remaining samples.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../startup/" title="Jupyter Setup" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Jupyter Setup
              </span>
            </div>
          </a>
        
        
          <a href="../assembly/" title="Assembly" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Assembly
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.ac79c3b0.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS_CHTML"></script>
      
    
  </body>
</html>